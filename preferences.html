<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Preferences - True Bayan</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
            rel="stylesheet">
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Merriweather:ital,wght@0,400;0,700;1,400&display=swap"
            rel="stylesheet">

        <style>
        :root {
            /* Modern Color Palette */
            --primary: #4F46E5;
            --primary-dark: #4338ca;
            --secondary: #ec4899;
            --dark: #111827;
            --text-body: #4b5563;
            --light-bg: #f3f4f6;
            --white: #ffffff;
            
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Inter', sans-serif;
            color: var(--dark);
            line-height: 1.6;
        }

        /* --- Navbar --- */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 15px 0;
            box-shadow: var(--shadow-sm);
        }

        .navbar-brand {
            font-weight: 800;
            font-size: 1.6rem;
            color: var(--primary) !important;
            letter-spacing: -0.5px;
        }

        .nav-link {
            color: var(--text-body) !important;
            font-weight: 600;
            font-size: 0.95rem;
            margin: 0 8px;
            transition: color 0.2s;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--primary) !important;
        }

        .btn-outline-primary {
            border-color: var(--primary);
            color: var(--primary);
            border-radius: 50px;
            padding: 8px 20px;
        }
        .btn-outline-primary:hover { background: var(--primary); color: white; }

        /* --- Main Container --- */
        .preferences-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            margin: 40px auto;
            max-width: 900px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title {
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 10px;
            font-size: 2rem;
            letter-spacing: -0.02em;
        }

        .page-subtitle {
            color: var(--text-body);
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .counter-badge {
            background: #e0e7ff;
            color: var(--primary);
            padding: 8px 20px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.9rem;
            display: inline-block;
        }

        /* --- Category Grid --- */
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .category-card {
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .category-card:hover {
            border-color: #c7d2fe;
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .category-card.active {
            border-color: var(--primary);
            background: #eef2ff;
            box-shadow: 0 0 0 1px var(--primary);
        }

        /* Checkmark Badge */
        .category-card.active::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            animation: popIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .category-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: #9ca3af;
            transition: color 0.2s;
        }

        .category-card.active .category-icon {
            color: var(--primary);
        }

        .category-name {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
            font-size: 1.05rem;
        }

        .category-desc {
            font-size: 0.8rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .form-check-input {
            display: none;
        }

        /* --- Save Button --- */
        .btn-save {
            background: var(--dark);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 15px 50px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.2s;
            box-shadow: var(--shadow-md);
        }

        .btn-save:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* Floating Chatbot */
        .floating-chat-btn {
            position: fixed;
            bottom: 30px; right: 30px;
            width: 65px; height: 65px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.6rem;
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
            transition: all 0.3s;
            z-index: 1000;
            text-decoration: none;
        }
        .floating-chat-btn:hover { transform: scale(1.1); color: white; }

        @media (max-width: 768px) {
            .preferences-card { padding: 30px 20px; margin: 20px; }
            .category-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; }
            .page-title { font-size: 1.6rem; }
            .btn-save { width: 100%; }
        }
        /* Chatbot CSS */
    :root { --chat-primary: #4F46E5; --chat-width: 380px; --chat-height: 600px; }
    
    /* Toggle Button */
    .chat-toggle-btn {
        position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px;
        background: linear-gradient(135deg, #4F46E5, #ec4899);
        border-radius: 50%; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4);
        display: flex; align-items: center; justify-content: center; color: white; font-size: 1.8rem;
        cursor: pointer; z-index: 9999; transition: all 0.3s; border: none;
    }
    .chat-toggle-btn:hover { transform: scale(1.1); box-shadow: 0 15px 35px rgba(79, 70, 229, 0.5); }

    /* Popup Window */
    .chat-popup {
        position: fixed; bottom: 110px; right: 30px;
        width: var(--chat-width); height: var(--chat-height); max-height: calc(100vh - 140px);
        background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(15px);
        border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(255,255,255,0.5); display: flex; flex-direction: column;
        overflow: hidden; z-index: 9998; opacity: 0; transform: translateY(20px) scale(0.95);
        pointer-events: none; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); transform-origin: bottom right;
    }
    .chat-popup.active { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }

    /* Header */
    .chat-header {
        background: linear-gradient(135deg, #4F46E5, #4338ca);
        padding: 20px; color: white; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
    }
    .bot-avatar {
        width: 35px; height: 35px; background: rgba(255,255,255,0.2); border-radius: 50%;
        display: flex; align-items: center; justify-content: center; font-size: 1.1rem;
    }
    .btn-close-chat { background: transparent; border: none; color: rgba(255,255,255,0.7); cursor: pointer; font-size: 1.1rem; }
    .btn-close-chat:hover { color: white; }

    /* Body */
    .chat-body { flex-grow: 1; padding: 20px; overflow-y: auto; background: #f8fafc; display: flex; flex-direction: column; gap: 15px; }
    .chat-body::-webkit-scrollbar { width: 5px; }
    .chat-body::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

    /* Messages */
    .message-row { display: flex; gap: 10px; align-items: flex-end; animation: popIn 0.3s ease; }
    .message-row.user { flex-direction: row-reverse; }
    .msg-bubble {
        max-width: 80%; padding: 10px 15px; font-size: 0.9rem; line-height: 1.5; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .message-row.bot .msg-bubble { background: white; color: #111827; border-radius: 15px 15px 15px 4px; border: 1px solid #e2e8f0; }
    .message-row.user .msg-bubble { background: #4F46E5; color: white; border-radius: 15px 15px 4px 15px; }
    @keyframes popIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Footer */
    .chat-footer { padding: 15px 20px; background: white; border-top: 1px solid #f1f5f9; }
    .input-group-chat { display: flex; align-items: center; background: #f8fafc; border-radius: 25px; padding: 5px 5px 5px 15px; border: 1px solid #e2e8f0; }
    .input-group-chat:focus-within { border-color: #4F46E5; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); background: white; }
    .chat-input { border: none; background: transparent; flex-grow: 1; font-size: 0.95rem; outline: none; color: #111827; }
    .btn-send { width: 35px; height: 35px; border-radius: 50%; background: #4F46E5; color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-left: 8px; }
    
    /* Mobile */
    @media (max-width: 480px) {
        .chat-popup { width: 100%; height: 100%; bottom: 0; right: 0; border-radius: 0; max-height: 100vh; }
        .chat-toggle-btn { bottom: 20px; right: 20px; }
    }
    </style>
    </head>
    <body>

        <nav class="navbar navbar-expand-lg sticky-top">
            <div class="container">
                <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                    <i class="fas fa-newspaper me-2"></i>True Bayan
                </a>
                <button class="navbar-toggler border-0" type="button"
                    data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="fas fa-bars text-dark"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item"><a class="nav-link"
                                href="{{ url_for('dashboard') }}">Home</a></li>
                        <li class="nav-item"><a class="nav-link"
                                href="{{ url_for('saved') }}">Saved</a></li>
                        <li class="nav-item"><a class="nav-link"
                                href="{{ url_for('fake_news_tracker') }}">Fake
                                News Tracker</a></li>
                        <li class="nav-item"><a class="nav-link"
                                href="{{ url_for('history') }}">History</a></li>
                        <li class="nav-item"><a class="nav-link active"
                                href="{{ url_for('preferences') }}">Preferences</a></li>
                        <li class="nav-item ms-lg-3">
                            <a class="btn btn-outline-primary btn-sm"
                                href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-1"></i> Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="mt-4">
                {% for category, message in messages %}
                <div
                    class="alert alert-{{ category }} alert-dismissible fade show rounded-4 shadow-sm border-0"
                    role="alert">
                    <i class="fas fa-info-circle me-2"></i> {{ message }}
                    <button type="button" class="btn-close"
                        data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endwith %}

            <div class="preferences-card">

                <div class="page-header">
                    <h1 class="page-title">Personalize Your Feed</h1>
                    <p class="page-subtitle">Select the topics that matter most
                        to you.</p>
                    <div class="counter-badge">
                        <span id="selected-count">0</span> categories selected
                    </div>
                </div>

                <form method="POST">
                    <div class="category-grid">

                        {% macro render_category(name, icon, desc, field_name,
                        is_checked) %}
                        <label
                            class="category-card {{ 'active' if is_checked else '' }}"
                            onclick="toggleCategory(this)">
                            <input type="checkbox" name="{{ field_name }}"
                                class="form-check-input" {{ 'checked' if
                                is_checked else '' }}>
                            <div class="category-icon">
                                <i class="fas fa-{{ icon }}"></i>
                            </div>
                            <div class="category-name">{{ name }}</div>
                            <div class="category-desc">{{ desc }}</div>
                        </label>
                        {% endmacro %}

                        {{ render_category('Politics', 'landmark',
                        'Government & policies', 'politics',
                        prefs.category_politics if prefs else False) }}
                        {{ render_category('Business', 'briefcase',
                        'Economy & finance', 'business', prefs.category_business
                        if prefs else False) }}
                        {{ render_category('Technology', 'laptop-code',
                        'Tech & innovation', 'technology',
                        prefs.category_technology if prefs else False) }}
                        {{ render_category('Sports', 'basketball-ball',
                        'Games & athletes', 'sports', prefs.category_sports if
                        prefs else False) }}
                        {{ render_category('Entertainment', 'film',
                        'Movies & celebrities', 'entertainment',
                        prefs.category_entertainment if prefs else False) }}
                        {{ render_category('Health', 'heartbeat',
                        'Wellness & medical', 'health', prefs.category_health if
                        prefs else False) }}
                        {{ render_category('Education', 'graduation-cap',
                        'Schools & learning', 'education',
                        prefs.category_education if prefs else False) }}
                        {{ render_category('Environment', 'leaf',
                        'Climate & nature', 'environment',
                        prefs.category_environment if prefs else False) }}
                        {{ render_category('Crime', 'gavel', 'Police & justice',
                        'crime', prefs.category_crime if prefs else False) }}
                        {{ render_category('Weather', 'cloud-sun',
                        'Forecasts & updates', 'weather', prefs.category_weather
                        if prefs else False) }}
                        {{ render_category('Lifestyle', 'palette',
                        'Fashion & culture', 'lifestyle',
                        prefs.category_lifestyle if prefs else False) }}
                        {{ render_category('Food', 'utensils',
                        'Cuisine & dining', 'food', prefs.category_food if prefs
                        else False) }}

                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-save">
                            <i class="fas fa-check me-2"></i> Save Preferences
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script>
        function updateCounter() {
            const checkedBoxes = document.querySelectorAll('.category-card input[type="checkbox"]:checked');
            document.getElementById('selected-count').textContent = checkedBoxes.length;
        }

        function toggleCategory(card) {
            // Checkbox logic is handled natively by the label click, 
            // but we need to update visual class manually for immediate feedback
            const checkbox = card.querySelector('input[type="checkbox"]');
            
            // Small delay to let the native check happen
            setTimeout(() => {
                if (checkbox.checked) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
                updateCounter();
            }, 0);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            updateCounter();
        });
    </script>

        <button class="chat-toggle-btn" id="chatToggle" onclick="toggleChat()">
    <i class="fas fa-comment-dots" id="toggleIcon"></i>
</button>

<div class="chat-popup" id="chatPopup">
    <div class="chat-header">
        <div style="display:flex; align-items:center; gap:12px;">
            <div class="bot-avatar"><i class="fas fa-robot"></i></div>
            <div>
                <h5 style="margin:0; font-weight:700;">True Bayan AI</h5>
                <span style="font-size:0.75rem; opacity:0.8;">Online</span>
            </div>
        </div>
        <button class="btn-close-chat" onclick="toggleChat()"><i class="fas fa-times"></i></button>
    </div>

    <div class="chat-body" id="chatBody">
        <div class="message-row bot">
            <div class="msg-bubble">
                Hello! ðŸ‘‹ I can help you check news credibility or answer questions about articles.
            </div>
        </div>
    </div>

    <div class="chat-footer">
        <form class="input-group-chat" onsubmit="handleChatSubmit(event)">
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." autocomplete="off">
            <button type="submit" class="btn-send"><i class="fas fa-paper-plane" style="font-size: 0.9rem;"></i></button>
        </form>
    </div>
</div>

<script>
    const chatPopup = document.getElementById('chatPopup');
    const toggleIcon = document.getElementById('toggleIcon');
    const chatBody = document.getElementById('chatBody');
    const chatInput = document.getElementById('chatInput');
    let isOpen = false;

    function toggleChat() {
        isOpen = !isOpen;
        if (isOpen) {
            chatPopup.classList.add('active');
            toggleIcon.classList.remove('fa-comment-dots');
            toggleIcon.classList.add('fa-chevron-down');
            setTimeout(() => chatInput.focus(), 300);
        } else {
            chatPopup.classList.remove('active');
            toggleIcon.classList.remove('fa-chevron-down');
            toggleIcon.classList.add('fa-comment-dots');
        }
    }

    async function handleChatSubmit(e) {
        e.preventDefault();
        const message = chatInput.value.trim();
        if (!message) return;

        appendMessage(message, 'user');
        chatInput.value = '';

        // Add loading bubble
        const loadingId = 'loading-' + Date.now();
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message-row bot';
        loadingDiv.id = loadingId;
        loadingDiv.innerHTML = `<div class="msg-bubble">...</div>`;
        chatBody.appendChild(loadingDiv);
        chatBody.scrollTop = chatBody.scrollHeight;

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });
            const data = await response.json();
            document.getElementById(loadingId).remove();
            appendMessage(data.response, 'bot');
        } catch (error) {
            document.getElementById(loadingId).remove();
            appendMessage("Connection error. Please try again.", 'bot');
        }
    }

    function appendMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message-row ${sender}`;
        div.innerHTML = `<div class="msg-bubble">${text.replace(/\n/g, '<br>')}</div>`;
        chatBody.appendChild(div);
        chatBody.scrollTop = chatBody.scrollHeight;
    }
</script>

    </body>
</html>